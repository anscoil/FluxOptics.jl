<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Field Retrieval · FluxOptics.jl</title><meta name="title" content="Field Retrieval · FluxOptics.jl"/><meta property="og:title" content="Field Retrieval · FluxOptics.jl"/><meta property="twitter:title" content="Field Retrieval · FluxOptics.jl"/><meta name="description" content="Documentation for FluxOptics.jl."/><meta property="og:description" content="Documentation for FluxOptics.jl."/><meta property="twitter:description" content="Documentation for FluxOptics.jl."/><meta property="og:url" content="https://anscoil.github.io/FluxOptics.jl/tutorials/02_field_retrieval/"/><meta property="twitter:url" content="https://anscoil.github.io/FluxOptics.jl/tutorials/02_field_retrieval/"/><link rel="canonical" href="https://anscoil.github.io/FluxOptics.jl/tutorials/02_field_retrieval/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="FluxOptics.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">FluxOptics.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../01_FoxLi_simulation/">FoxLi Simulation</a></li><li class="is-active"><a class="tocitem" href>Field Retrieval</a><ul class="internal"><li><a class="tocitem" href="#The-Phase-Problem"><span>The Phase Problem</span></a></li><li><a class="tocitem" href="#Ground-Truth:-Laguerre-Gaussian-Mode"><span>Ground Truth: Laguerre-Gaussian Mode</span></a></li><li><a class="tocitem" href="#Intensity-Measurements"><span>Intensity Measurements</span></a></li><li><a class="tocitem" href="#Initial-Guess:-Random-Speckle"><span>Initial Guess: Random Speckle</span></a></li><li><a class="tocitem" href="#Optical-System-Setup"><span>Optical System Setup</span></a></li><li><a class="tocitem" href="#Loss-Function"><span>Loss Function</span></a></li><li><a class="tocitem" href="#Optimization"><span>Optimization</span></a></li><li><a class="tocitem" href="#Reconstructed-Field"><span>Reconstructed Field</span></a></li><li><a class="tocitem" href="#Reconstruction-Quality"><span>Reconstruction Quality</span></a></li></ul></li><li><a class="tocitem" href="../03_RGB_beam_shaping/">Multi-Wavelength Beam Shaping</a></li><li><a class="tocitem" href="../04_waveguide_tomography/">Waveguide Tomography</a></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../api/">API Reference</a></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">GridUtils</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/gridutils/">GridUtils</a></li><li><a class="tocitem" href="../../api/gridutils/gridutils/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Modes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/modes/">Modes</a></li><li><a class="tocitem" href="../../api/modes/modes/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Fields</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/fields/">Fields</a></li><li><a class="tocitem" href="../../api/fields/fields/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Optical Components</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/">Optical Components</a></li><li><input class="collapse-toggle" id="menuitem-3-5-2" type="checkbox"/><label class="tocitem" for="menuitem-3-5-2"><span class="docs-label">Core</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/core/">Core</a></li><li><a class="tocitem" href="../../api/optical_components/core/core/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-3" type="checkbox"/><label class="tocitem" for="menuitem-3-5-3"><span class="docs-label">Sources</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/sources/">Sources</a></li><li><a class="tocitem" href="../../api/optical_components/sources/sources/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-4" type="checkbox"/><label class="tocitem" for="menuitem-3-5-4"><span class="docs-label">Modulators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/modulators/">Modulators</a></li><li><a class="tocitem" href="../../api/optical_components/modulators/modulators/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5-5"><span class="docs-label">Fourier</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/fourier/">Fourier</a></li><li><a class="tocitem" href="../../api/optical_components/fourier/fourier/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-6" type="checkbox"/><label class="tocitem" for="menuitem-3-5-6"><span class="docs-label">Utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/utilities/">Utilities</a></li><li><a class="tocitem" href="../../api/optical_components/utilities/utilities/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-7" type="checkbox"/><label class="tocitem" for="menuitem-3-5-7"><span class="docs-label">Free-Space Propagators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/freespace/">Free-Space Propagators</a></li><li><a class="tocitem" href="../../api/optical_components/freespace/freespace/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-8" type="checkbox"/><label class="tocitem" for="menuitem-3-5-8"><span class="docs-label">Bulk Propagators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/bulk/">Bulk Propagators</a></li><li><a class="tocitem" href="../../api/optical_components/bulk/bulk/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-9" type="checkbox"/><label class="tocitem" for="menuitem-3-5-9"><span class="docs-label">Active Media</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/active/">Active Media</a></li><li><a class="tocitem" href="../../api/optical_components/active/active_media/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-10" type="checkbox"/><label class="tocitem" for="menuitem-3-5-10"><span class="docs-label">System</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/system/">System</a></li><li><a class="tocitem" href="../../api/optical_components/system/system/">API</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">OptimisersExt</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optimisers/">OptimisersExt</a></li><li><a class="tocitem" href="../../api/optimisers/optimisers/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox"/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">Metrics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/metrics/">Metrics</a></li><li><a class="tocitem" href="../../api/metrics/metrics/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-8" type="checkbox"/><label class="tocitem" for="menuitem-3-8"><span class="docs-label">Plotting</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/plotting/">Plotting</a></li><li><a class="tocitem" href="../../api/plotting/plotting/">API</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Field Retrieval</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Field Retrieval</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/anscoil/FluxOptics.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/anscoil/FluxOptics.jl/blob/main/docs/src/tutorials/02_field_retrieval.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Field-Retrieval:-Reconstructing-Complex-Fields-from-Intensity-Measurements"><a class="docs-heading-anchor" href="#Field-Retrieval:-Reconstructing-Complex-Fields-from-Intensity-Measurements">Field Retrieval: Reconstructing Complex Fields from Intensity Measurements</a><a id="Field-Retrieval:-Reconstructing-Complex-Fields-from-Intensity-Measurements-1"></a><a class="docs-heading-anchor-permalink" href="#Field-Retrieval:-Reconstructing-Complex-Fields-from-Intensity-Measurements" title="Permalink"></a></h1><p>This tutorial demonstrates phase retrieval using gradient-based optimization. From intensity-only measurements in two planes, we reconstruct the full complex field (amplitude and phase) using automatic differentiation.</p><h2 id="The-Phase-Problem"><a class="docs-heading-anchor" href="#The-Phase-Problem">The Phase Problem</a><a id="The-Phase-Problem-1"></a><a class="docs-heading-anchor-permalink" href="#The-Phase-Problem" title="Permalink"></a></h2><p>Standard detectors measure only intensity |u|², losing phase information. However, with measurements at multiple propagation distances, the complex field can be recovered through optimization - a generalization of the Gerchberg-Saxton algorithm using gradients rather than alternating projections.</p><pre><code class="language-julia hljs">using FluxOptics, Zygote, CairoMakie
using Random
Random.seed!(15);  # Determinist example</code></pre><h2 id="Ground-Truth:-Laguerre-Gaussian-Mode"><a class="docs-heading-anchor" href="#Ground-Truth:-Laguerre-Gaussian-Mode">Ground Truth: Laguerre-Gaussian Mode</a><a id="Ground-Truth:-Laguerre-Gaussian-Mode-1"></a><a class="docs-heading-anchor-permalink" href="#Ground-Truth:-Laguerre-Gaussian-Mode" title="Permalink"></a></h2><p>We create a high-order LG mode as our target field. This will serve as the ground truth - we&#39;ll measure its intensity at two planes, then attempt to reconstruct the complex field from these measurements alone.</p><pre><code class="language-julia hljs">ns = 512, 512
ds = 2.0, 2.0
x_vec, y_vec = spatial_vectors(ns, ds)

λ = 1.064
z1 = 5000.0
z2 = 15000.0

w0 = 50.0
m, n = 2, 3

u0_th = LaguerreGaussian(w0, m, n; kind = :odd)(x_vec, y_vec)
u1_th = LaguerreGaussian(w0, m, n, λ, z1; kind = :odd)(x_vec, y_vec)
u2_th = LaguerreGaussian(w0, m, n, λ, z2; kind = :odd)(x_vec, y_vec)

visualize(((u0_th, u1_th, u2_th),), intensity; colormap=:inferno, height=120)</code></pre><p><img src="../../assets/02_field_retrieval_ground_truth.png" alt="Ground truth LG mode at z=0, z₁, and z₂"/></p><h2 id="Intensity-Measurements"><a class="docs-heading-anchor" href="#Intensity-Measurements">Intensity Measurements</a><a id="Intensity-Measurements-1"></a><a class="docs-heading-anchor-permalink" href="#Intensity-Measurements" title="Permalink"></a></h2><p>In a real experiment, we would measure only the intensity at two planes. Here we simulate these measurements from our known ground truth.</p><pre><code class="language-julia hljs">I1 = abs.(u1_th) .^ 2
I2 = abs.(u2_th) .^ 2

@assert isapprox(sum(I1)*prod(ds), 1; atol = 1e-7)  # Power normalized to unity
@assert isapprox(sum(I2)*prod(ds), 1; atol = 1e-7)  # Power normalized to unity


visualize(((I1, I2),), real; colormap=:inferno, height=120)</code></pre><p><img src="../../assets/02_field_retrieval_measurements.png" alt="Intensity measurements at z₁=5mm and z₂=15mm"/></p><h2 id="Initial-Guess:-Random-Speckle"><a class="docs-heading-anchor" href="#Initial-Guess:-Random-Speckle">Initial Guess: Random Speckle</a><a id="Initial-Guess:-Random-Speckle-1"></a><a class="docs-heading-anchor-permalink" href="#Initial-Guess:-Random-Speckle" title="Permalink"></a></h2><p>We start from a random speckle pattern - a generic field with no knowledge of the target mode. The optimization will transform this into the LG mode.</p><pre><code class="language-julia hljs">NA = 0.01
speckle_dist = generate_speckle(ns, ds, λ, NA; envelope = Gaussian(3*w0))
u0 = ScalarField(speckle_dist, ds, λ)

visualize(u0, (intensity, complex); colormap=(:inferno, :dark), height=120)</code></pre><p><img src="../../assets/02_field_retrieval_initial.png" alt="Initial random speckle field"/></p><h2 id="Optical-System-Setup"><a class="docs-heading-anchor" href="#Optical-System-Setup">Optical System Setup</a><a id="Optical-System-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Optical-System-Setup" title="Permalink"></a></h2><p>We construct the propagation system with probes to capture fields at measurement planes. The source field is trainable - its complex values will be optimized.</p><pre><code class="language-julia hljs">p1 = RSProp(u0, z1; use_cache = true)
p2 = RSProp(u0, z2-z1; use_cache = true)

s = ScalarSource(u0; trainable = true, buffered = true)
fp1 = FieldProbe()
fp2 = FieldProbe()

system = s |&gt; p1 |&gt; fp1 |&gt; p2 |&gt; fp2 |&gt; (; inplace = true);</code></pre><h2 id="Loss-Function"><a class="docs-heading-anchor" href="#Loss-Function">Loss Function</a><a id="Loss-Function-1"></a><a class="docs-heading-anchor-permalink" href="#Loss-Function" title="Permalink"></a></h2><p>We minimize the difference between predicted and measured intensities using a correlation-based metric. The loss is defined as 2 - (correlation₁ + correlation₂), where perfect reconstruction gives loss = 0.</p><pre><code class="language-julia hljs">sI1 = sqrt.(I1)
sI2 = sqrt.(I2)
eps = 1e-15 * maximum(I1)

function f_opt(m)
    _, probes = m()
    u1 = probes[fp1]
    u2 = probes[fp2]
    (2 -
     (dot(sqrt.(abs2.(u1.electric) .+ eps), sI1) +
      dot(sqrt.(abs2.(u2.electric) .+ eps), sI2)) * prod(ds))
end</code></pre><h2 id="Optimization"><a class="docs-heading-anchor" href="#Optimization">Optimization</a><a id="Optimization-1"></a><a class="docs-heading-anchor-permalink" href="#Optimization" title="Permalink"></a></h2><p>We use FISTA (Fast Iterative Shrinkage-Thresholding Algorithm) with gradient-based optimization. The non-convex nature of phase retrieval means convergence can take many iterations, with the optimizer navigating through local minima. Power normalization at each step prevents divergence.</p><pre><code class="language-julia hljs">opt = setup(Fista(1), system)

fill!(s, u0)
losses = Float64[]

for i in 1:1000
    val, grads = Zygote.withgradient(f_opt, system)
    FluxOptics.update!(opt, system, grads[1])
    normalize_power!(get_source(s), 1)  # Power normalization to avoid divergence
    push!(losses, val)
end</code></pre><p>The convergence curve reveals the non-convex nature of the phase retrieval problem, with several plateaus before reaching the global minimum.</p><p><img src="../../assets/02_field_retrieval_convergence.png" alt="Convergence showing non-convex optimization landscape with multiple plateaus"/></p><h2 id="Reconstructed-Field"><a class="docs-heading-anchor" href="#Reconstructed-Field">Reconstructed Field</a><a id="Reconstructed-Field-1"></a><a class="docs-heading-anchor-permalink" href="#Reconstructed-Field" title="Permalink"></a></h2><p>After optimization, we extract the reconstructed field and propagated versions at the measurement planes. The complex field structure (intensity and phase) is successfully recovered from intensity-only measurements.</p><pre><code class="language-julia hljs">_, probes = system()
u1 = probes[fp1]
u2 = probes[fp2]

visualize((s, u1, u2), (intensity, phase);
           colormap=(:inferno, :twilight), show_colorbars=true, height=150)</code></pre><p><img src="../../assets/02_field_retrieval_result.png" alt="Reconstructed field at z=0, z₁, and z₂ - intensity (top) and phase (bottom)"/></p><h2 id="Reconstruction-Quality"><a class="docs-heading-anchor" href="#Reconstruction-Quality">Reconstruction Quality</a><a id="Reconstruction-Quality-1"></a><a class="docs-heading-anchor-permalink" href="#Reconstruction-Quality" title="Permalink"></a></h2><p>We quantify reconstruction quality using coupling efficiency - the overlap integral between reconstructed and true fields. Values above 99% indicate excellent reconstruction.</p><table><tr><th style="text-align: right">Plane</th><th style="text-align: right">Coupling Efficiency</th></tr><tr><td style="text-align: right">z = 0</td><td style="text-align: right">99.995%</td></tr><tr><td style="text-align: right">z₁ = 5 mm</td><td style="text-align: right">99.995%</td></tr><tr><td style="text-align: right">z₂ = 15 mm</td><td style="text-align: right">99.995%</td></tr></table><p>The reconstruction achieves &gt;99.99% coupling efficiency, demonstrating accurate recovery of both amplitude and phase from intensity measurements alone.</p><blockquote><p><strong>Extension to Noisy Measurements</strong></p><p>With realistic measurement noise, regularization techniques such as Total Variation (TV) or support constraints become necessary. The core optimization framework remains the same, with proximal operators added to the optimization rule.</p></blockquote><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../01_FoxLi_simulation/">« FoxLi Simulation</a><a class="docs-footer-nextpage" href="../03_RGB_beam_shaping/">Multi-Wavelength Beam Shaping »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Thursday 23 October 2025 19:08">Thursday 23 October 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
