<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Waveguide Tomography · FluxOptics.jl</title><meta name="title" content="Waveguide Tomography · FluxOptics.jl"/><meta property="og:title" content="Waveguide Tomography · FluxOptics.jl"/><meta property="twitter:title" content="Waveguide Tomography · FluxOptics.jl"/><meta name="description" content="Documentation for FluxOptics.jl."/><meta property="og:description" content="Documentation for FluxOptics.jl."/><meta property="twitter:description" content="Documentation for FluxOptics.jl."/><meta property="og:url" content="https://anscoil.github.io/FluxOptics.jl/tutorials/04_waveguide_tomography/"/><meta property="twitter:url" content="https://anscoil.github.io/FluxOptics.jl/tutorials/04_waveguide_tomography/"/><link rel="canonical" href="https://anscoil.github.io/FluxOptics.jl/tutorials/04_waveguide_tomography/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.svg" alt="FluxOptics.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">FluxOptics.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../01_FoxLi_simulation/">FoxLi Simulation</a></li><li><a class="tocitem" href="../02_field_retrieval/">Field Retrieval</a></li><li><a class="tocitem" href="../03_RGB_beam_shaping/">Multi-Wavelength Beam Shaping</a></li><li class="is-active"><a class="tocitem" href>Waveguide Tomography</a><ul class="internal"><li><a class="tocitem" href="#Physical-Setup"><span>Physical Setup</span></a></li><li><a class="tocitem" href="#Experimental-Data"><span>Experimental Data</span></a></li><li><a class="tocitem" href="#Angular-Selection"><span>Angular Selection</span></a></li><li><a class="tocitem" href="#Forward-Model:-Beam-Propagation-Through-Sample"><span>Forward Model: Beam Propagation Through Sample</span></a></li><li><a class="tocitem" href="#Aberration-Correction"><span>Aberration Correction</span></a></li><li><a class="tocitem" href="#Loss-Function-and-Optimization-Setup"><span>Loss Function and Optimization Setup</span></a></li><li><a class="tocitem" href="#Reconstruction-Loop"><span>Reconstruction Loop</span></a></li><li><a class="tocitem" href="#Reconstructed-Intensity-Pattern"><span>Reconstructed Intensity Pattern</span></a></li><li><a class="tocitem" href="#Refractive-Index-Profile"><span>Refractive Index Profile</span></a></li><li><a class="tocitem" href="#Recovered-Aberration-Profile"><span>Recovered Aberration Profile</span></a></li><li><a class="tocitem" href="#Summary"><span>Summary</span></a></li></ul></li></ul></li><li><span class="tocitem">Reference</span><ul><li><a class="tocitem" href="../../api/">API Reference</a></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">GridUtils</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/gridutils/">GridUtils</a></li><li><a class="tocitem" href="../../api/gridutils/gridutils/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Modes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/modes/">Modes</a></li><li><a class="tocitem" href="../../api/modes/modes/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Fields</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/fields/">Fields</a></li><li><a class="tocitem" href="../../api/fields/fields/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Optical Components</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/">Optical Components</a></li><li><input class="collapse-toggle" id="menuitem-3-5-2" type="checkbox"/><label class="tocitem" for="menuitem-3-5-2"><span class="docs-label">Core</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/core/">Core</a></li><li><a class="tocitem" href="../../api/optical_components/core/core/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-3" type="checkbox"/><label class="tocitem" for="menuitem-3-5-3"><span class="docs-label">Sources</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/sources/">Sources</a></li><li><a class="tocitem" href="../../api/optical_components/sources/sources/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-4" type="checkbox"/><label class="tocitem" for="menuitem-3-5-4"><span class="docs-label">Modulators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/modulators/">Modulators</a></li><li><a class="tocitem" href="../../api/optical_components/modulators/modulators/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5-5"><span class="docs-label">Fourier</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/fourier/">Fourier</a></li><li><a class="tocitem" href="../../api/optical_components/fourier/fourier/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-6" type="checkbox"/><label class="tocitem" for="menuitem-3-5-6"><span class="docs-label">Utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/utilities/">Utilities</a></li><li><a class="tocitem" href="../../api/optical_components/utilities/utilities/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-7" type="checkbox"/><label class="tocitem" for="menuitem-3-5-7"><span class="docs-label">Free-Space Propagators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/freespace/">Free-Space Propagators</a></li><li><a class="tocitem" href="../../api/optical_components/freespace/freespace/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-8" type="checkbox"/><label class="tocitem" for="menuitem-3-5-8"><span class="docs-label">Bulk Propagators</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/bulk/">Bulk Propagators</a></li><li><a class="tocitem" href="../../api/optical_components/bulk/bulk/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-9" type="checkbox"/><label class="tocitem" for="menuitem-3-5-9"><span class="docs-label">Active Media</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/active/">Active Media</a></li><li><a class="tocitem" href="../../api/optical_components/active/active_media/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5-10" type="checkbox"/><label class="tocitem" for="menuitem-3-5-10"><span class="docs-label">System</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optical_components/system/">System</a></li><li><a class="tocitem" href="../../api/optical_components/system/system/">API</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">OptimisersExt</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/optimisers/">OptimisersExt</a></li><li><a class="tocitem" href="../../api/optimisers/optimisers/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-7" type="checkbox"/><label class="tocitem" for="menuitem-3-7"><span class="docs-label">Metrics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/metrics/">Metrics</a></li><li><a class="tocitem" href="../../api/metrics/metrics/">API</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-8" type="checkbox"/><label class="tocitem" for="menuitem-3-8"><span class="docs-label">Plotting</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../api/plotting/">Plotting</a></li><li><a class="tocitem" href="../../api/plotting/plotting/">API</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Waveguide Tomography</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Waveguide Tomography</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/anscoil/FluxOptics.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/anscoil/FluxOptics.jl/blob/main/docs/src/tutorials/04_waveguide_tomography.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Waveguide-Tomography:-Cross-Section-Reconstruction"><a class="docs-heading-anchor" href="#Waveguide-Tomography:-Cross-Section-Reconstruction">Waveguide Tomography: Cross-Section Reconstruction</a><a id="Waveguide-Tomography:-Cross-Section-Reconstruction-1"></a><a class="docs-heading-anchor-permalink" href="#Waveguide-Tomography:-Cross-Section-Reconstruction" title="Permalink"></a></h1><p>This tutorial demonstrates tomographic reconstruction of the refractive index profile of a photoinscribed waveguide in glass. By measuring the transmitted intensity at multiple illumination angles, we reconstruct the 2D cross-section of the waveguide using angular spectrum beam propagation and inverse optimization.</p><blockquote><p><strong>Reference</strong></p><p>This tutorial follows the approach described in: N. Barré, R. Shivaraman, L. Ackermann, S. Moser, M. Schmidt, P. Salter, M. Booth, and A. Jesacher, <a href="https://doi.org/10.1364/OE.434846">&quot;Tomographic refractive index profiling of direct laser written waveguides&quot;</a>, Opt. Express <strong>29</strong>, 35414-35425 (2021).</p></blockquote><p>Unlike traditional tomography based on the Born or Rytov approximations, this approach uses full wave propagation through the sample with accelerated proximal gradient descent. This handles strong refractive index contrasts and gradients without approximation. A key feature is joint estimation of optical aberrations alongside the refractive index profile, which is critical for using high-angle data and achieving accurate reconstructions.</p><h2 id="Physical-Setup"><a class="docs-heading-anchor" href="#Physical-Setup">Physical Setup</a><a id="Physical-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Physical-Setup" title="Permalink"></a></h2><p>The waveguide is invariant along the propagation direction (y), allowing us to treat it as a 2D problem. We illuminate the sample at different angles θ and measure the transmitted intensity pattern. The angular diversity provides the tomographic information needed to reconstruct the refractive index profile Δn(x,z).</p><pre><code class="language-julia hljs">using FluxOptics, Zygote, CairoMakie
using JLD</code></pre><h2 id="Experimental-Data"><a class="docs-heading-anchor" href="#Experimental-Data">Experimental Data</a><a id="Experimental-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Experimental-Data" title="Permalink"></a></h2><p>We load the measured intensity map I(x,θ) showing the transmitted field intensity as a function of transverse position x and illumination angle θ. The data comes from a photoinscribed waveguide in borosilicate glass.</p><pre><code class="language-julia hljs">data = &quot;docs/literate/data&quot;

tomogram_data = load(&quot;$(data)/tomogram_guide_b.jld&quot;)

dx = tomogram_data[&quot;dx&quot;]              # Pixel size (μm)
I_measured = tomogram_data[&quot;I&quot;]       # Intensity map I(x,θ)
θ_angles = tomogram_data[&quot;θ_l&quot;];      # Illumination angles (rad)</code></pre><p>Visualize the full measured tomogram showing intensity variation with angle</p><pre><code class="language-julia hljs">fig_full = Figure(size = (380, 300))
ax = Axis(fig_full[1, 1], xlabel = &quot;Angle θ (°)&quot;, ylabel = &quot;Position x (μm)&quot;, aspect = 1.1)
hm = heatmap!(ax, rad2deg.(θ_angles), (0:size(I_measured, 1)-1) .* dx, I_measured&#39;)
Colorbar(fig_full[1, 2], hm)
fig_full</code></pre><p><img src="../../assets/04_waveguide_tomography_data_full.png" alt="Full measured tomogram showing intensity vs angle and position"/></p><h2 id="Angular-Selection"><a class="docs-heading-anchor" href="#Angular-Selection">Angular Selection</a><a id="Angular-Selection-1"></a><a class="docs-heading-anchor-permalink" href="#Angular-Selection" title="Permalink"></a></h2><p>We select a subset of angles around normal incidence (θ ≈ 0) for reconstruction. Each angle provides a different view of the waveguide structure. The intensities are normalized to unit power at each angle.</p><pre><code class="language-julia hljs">angle_indices = (25 - 20):1:(25 + 22)
θ_selected = θ_angles[angle_indices]
I_selected = I_measured[:, angle_indices]
I_selected .*= size(I_selected, 1) ./ sum(I_selected, dims = 1)

nx = size(I_selected, 1)
n_angles = length(θ_selected);</code></pre><p>Visualize the selected angular range used for reconstruction</p><pre><code class="language-julia hljs">fig_selected = Figure(size = (380, 300))
ax = Axis(fig_selected[1, 1], xlabel = &quot;Angle θ (°)&quot;, ylabel = &quot;Position x (μm)&quot;, aspect = 1.1)
hm = heatmap!(ax, rad2deg.(θ_selected), (0:nx-1) .* dx, I_selected&#39;)
Colorbar(fig_selected[1, 2], hm)
fig_selected</code></pre><p><img src="../../assets/04_waveguide_tomography_data_selected.png" alt="Selected angular range for reconstruction"/></p><h2 id="Forward-Model:-Beam-Propagation-Through-Sample"><a class="docs-heading-anchor" href="#Forward-Model:-Beam-Propagation-Through-Sample">Forward Model: Beam Propagation Through Sample</a><a id="Forward-Model:-Beam-Propagation-Through-Sample-1"></a><a class="docs-heading-anchor-permalink" href="#Forward-Model:-Beam-Propagation-Through-Sample" title="Permalink"></a></h2><p>We construct the optical system modeling wave propagation through the waveguide. The system consists of:</p><ol><li>Multi-angle plane wave illumination with tilts θ</li><li>AS-BPM propagation through the sample (trainable refractive index)</li><li>Free-space propagation with NA-limited collection aperture</li><li>Aberration correction using a Fourier-space phase basis</li></ol><pre><code class="language-julia hljs">n_bulk = 1.52        # Bulk refractive index of glass
λ = 0.455            # Blue illumination wavelength (μm)
NA = 1.4             # Numerical aperture of collection optics
nz = 300             # Number of propagation steps
L_sample = 20        # Sample thickness (μm)
Δn_initial = zeros(nx, nz);  # Initial refractive index perturbation</code></pre><p>Create multi-angle source field</p><pre><code class="language-julia hljs">u0 = ScalarField((nx, n_angles), (dx,), λ; tilts = (θ_selected,))
fill!(u0, 1)
s = ScalarSource(u0);</code></pre><p>Beam propagation through sample (trainable)</p><pre><code class="language-julia hljs">sample = AS_BPM(u0, L_sample, n_bulk, Δn_initial;
                use_cache = false, trainable = true, buffered = true);</code></pre><p>NA-limited collection aperture</p><pre><code class="language-julia hljs">make_diaphragm(NA, λ) = fx -&gt; abs(fx) &lt;= abs(NA/λ) ? true : false

Δz_propagation = -6  # Free-space propagation distance (μm)
p_collection = ASProp(u0, Δz_propagation; n0 = n_bulk,
                      filter = make_diaphragm(NA, λ),
                      use_cache = false);  # Small data: cache slower than recompute</code></pre><h2 id="Aberration-Correction"><a class="docs-heading-anchor" href="#Aberration-Correction">Aberration Correction</a><a id="Aberration-Correction-1"></a><a class="docs-heading-anchor-permalink" href="#Aberration-Correction" title="Permalink"></a></h2><p>Optical aberrations in the collection path (e.g., from refractive index mismatch between sample and immersion medium) are modeled using a radial polynomial basis in Fourier space. We jointly estimate these aberrations alongside the refractive index profile - a form of blind deconvolution.</p><p>This joint estimation is crucial: the paper shows that neglecting aberrations produces significant artifacts in the reconstructed index profile, especially when using high-angle illumination data. The radial polynomial basis (even orders up to 16th) captures spherical-like aberrations common in high-NA imaging systems.</p><pre><code class="language-julia hljs">spatial_freq_offsets = sin.(θ_selected) .* (n_bulk/λ)

function radial_polynomial(fx, f0, λ, NA, p)
    abs(fx + f0) &lt;= abs(NA/λ) ? (abs(fx + f0) * λ / NA)^(2*p) : 0.0
end

aberration_mask = FourierPhase(u0, zeros(nx, n_angles);
                               trainable = true, buffered = true);

n_basis = 8
basis_functions = make_fourier_basis((fx, f0, p) -&gt; radial_polynomial(fx, f0, λ, NA, p),
                                     (nx,), (dx,), spatial_freq_offsets, (1:n_basis)&#39;)
aberration_wrapper = BasisProjectionWrapper(aberration_mask, basis_functions,
                                            zeros(n_basis));</code></pre><p>Complete optical system</p><pre><code class="language-julia hljs">system = s |&gt; sample |&gt; p_collection |&gt; aberration_wrapper |&gt;
         (; inplace = true, merge_components = true);</code></pre><h2 id="Loss-Function-and-Optimization-Setup"><a class="docs-heading-anchor" href="#Loss-Function-and-Optimization-Setup">Loss Function and Optimization Setup</a><a id="Loss-Function-and-Optimization-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Loss-Function-and-Optimization-Setup" title="Permalink"></a></h2><p>We minimize the squared difference between measured and simulated intensities. The waveguide refractive index and aberration coefficients are jointly optimized.</p><p>For regularization, we use ISTA (Iterative Shrinkage-Thresholding Algorithm) which promotes sparsity in the reconstruction. This is simpler than the TV-norm regularization used in the original paper, and produces smoother profiles without the &quot;staircase&quot; artifacts characteristic of total variation methods.</p><pre><code class="language-julia hljs">I_target = similar(u0.electric, real(eltype(u0)))
copyto!(I_target, I_selected)

intensity_metric = SquaredIntensityDifference((u0, I_target));

f_opt = m -&gt; sum(intensity_metric(m().out));</code></pre><p>Initialize trainable components</p><pre><code class="language-julia hljs">fill!(sample, 0)
fill!(aberration_wrapper, 0)
fill!(aberration_mask, 0);</code></pre><p>Separate optimization rules for sample and aberrations</p><pre><code class="language-julia hljs">sample_rule = ProxRule(Fista(0.01), IstaProx(3e-5))  # ISTA regularization
aberration_rule = Fista(0.03)

rules_dict = make_rules(sample =&gt; sample_rule,
                        aberration_wrapper =&gt; aberration_rule)

opt = FluxOptics.setup(rules_dict, system)</code></pre><h2 id="Reconstruction-Loop"><a class="docs-heading-anchor" href="#Reconstruction-Loop">Reconstruction Loop</a><a id="Reconstruction-Loop-1"></a><a class="docs-heading-anchor-permalink" href="#Reconstruction-Loop" title="Permalink"></a></h2><p>We run 50 iterations of FISTA with proximal regularization. The algorithm alternates between updating the refractive index profile and correcting for optical aberrations, progressively refining the tomographic reconstruction.</p><pre><code class="language-julia hljs">losses = Float64[]

for i in 1:50
    val, grads = Zygote.withgradient(f_opt, system)
    FluxOptics.update!(opt, system, grads[1])
    push!(losses, val)
end</code></pre><p>Convergence curve showing reconstruction progress</p><pre><code class="language-julia hljs">fig_loss = Figure(size = (380, 300))
ax = Makie.Axis(fig_loss[1, 1], yscale = log10, xlabel = &quot;Iteration&quot;, ylabel = &quot;Loss&quot;)
lines!(ax, losses; linewidth = 2)
fig_loss</code></pre><p><img src="../../assets/04_waveguide_tomography_convergence.png" alt="Convergence of tomographic reconstruction"/></p><h2 id="Reconstructed-Intensity-Pattern"><a class="docs-heading-anchor" href="#Reconstructed-Intensity-Pattern">Reconstructed Intensity Pattern</a><a id="Reconstructed-Intensity-Pattern-1"></a><a class="docs-heading-anchor-permalink" href="#Reconstructed-Intensity-Pattern" title="Permalink"></a></h2><p>The optimized forward model closely matches the measured intensities across all angles, validating the reconstruction accuracy.</p><pre><code class="language-julia hljs">I_reconstructed = abs2.(collect(system().out))

fig_recon_intensity = Figure(size = (380, 300))
ax = Axis(fig_recon_intensity[1, 1],
           xlabel = &quot;Angle θ (°)&quot;, ylabel = &quot;Position x (μm)&quot;, aspect = 1.1)
I_reconstructed = abs2.(collect(system().out))
hm = heatmap!(ax, rad2deg.(θ_selected), (0:nx-1) .* dx, I_reconstructed&#39;)
Colorbar(fig_recon_intensity[1, 2], hm)
fig_recon_intensity</code></pre><p><img src="../../assets/04_waveguide_tomography_reconstructed_intensity.png" alt="Reconstructed intensity pattern matching measurements"/></p><h2 id="Refractive-Index-Profile"><a class="docs-heading-anchor" href="#Refractive-Index-Profile">Refractive Index Profile</a><a id="Refractive-Index-Profile-1"></a><a class="docs-heading-anchor-permalink" href="#Refractive-Index-Profile" title="Permalink"></a></h2><p>The reconstructed 2D refractive index perturbation Δn(x,z) reveals the waveguide cross-section. The computational domain was chosen large enough to accommodate high-angle illumination without edge effects. We now crop to the central region containing the waveguide for visualization. The photoinscribed region shows increased refractive index, characteristic of direct laser writing in glass.</p><pre><code class="language-julia hljs">n_trim = 550  # Crop to central region containing the waveguide
Δn_reconstructed = collect(sample)[(1 + n_trim):(end - n_trim), end:-1:1]

fig_profile = Figure(size = (420, 300))
ax = Axis(fig_profile[1, 1], xlabel = &quot;Position x (μm)&quot;, ylabel = &quot;Depth z (μm)&quot;)
hm = heatmap!(ax, (0:(nx - 2*n_trim - 1)) .* dx, (0:(nz-1)) .* (L_sample/nz), Δn_reconstructed)
ax.aspect = DataAspect()
ylims!(ax, L_sample, 0)
Colorbar(fig_profile[1, 2], hm, label = &quot;Δn&quot;)
fig_profile</code></pre><p><img src="../../assets/04_waveguide_tomography_refractive_index.png" alt="Reconstructed refractive index profile Δn(x,z) of the photoinscribed waveguide"/></p><h2 id="Recovered-Aberration-Profile"><a class="docs-heading-anchor" href="#Recovered-Aberration-Profile">Recovered Aberration Profile</a><a id="Recovered-Aberration-Profile-1"></a><a class="docs-heading-anchor-permalink" href="#Recovered-Aberration-Profile" title="Permalink"></a></h2><p>The optimization also recovers the optical aberration profile as a function of numerical aperture. The radial polynomial basis captures symmetric aberrations in the collection optics. The phase correction is valid within the collection NA window (shown by red dashed lines).</p><pre><code class="language-julia hljs">NA_range = (-NA):0.01:NA
fx_range = NA_range ./ λ
coefficients = collect(aberration_wrapper)
aberration_phase = sum([coefficients[i] * radial_polynomial.(fx_range, 0, λ, NA, p)
                        for (i, p) in enumerate(1:n_basis)])

fig_aberration = Figure(size = (380, 280))
ax = Axis(fig_aberration[1, 1], xlabel = &quot;Numerical Aperture&quot;, ylabel = &quot;Phase (rad)&quot;,
          xticks = ([-NA, 0, NA], [&quot;-NA&quot;, &quot;0&quot;, &quot;NA&quot;]))
lines!(ax, NA_range, aberration_phase; linewidth = 2)
vlines!(ax, [NA, -NA]; linestyle = :dash, color = :red, linewidth = 1.5)
fig_aberration</code></pre><p><img src="../../assets/04_waveguide_tomography_aberration.png" alt="Reconstructed aberration profile as a function of numerical aperture"/></p><h2 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h2><p>This tomographic reconstruction demonstrates several key capabilities:</p><ol><li><p><strong>Full wave propagation</strong>: Unlike Born/Rytov approximations, we use full angular spectrum beam propagation, handling strong index contrasts accurately.</p></li><li><p><strong>Joint optimization</strong>: Simultaneous reconstruction of refractive index profile and optical aberrations (blind deconvolution) enables use of high-angle data.</p></li><li><p><strong>Modern optimization</strong>: FISTA with proximal operators provides efficient convergence. ISTA regularization produces smooth profiles without the staircase artifacts of TV-norm methods used in earlier implementations.</p></li><li><p><strong>Quantitative imaging</strong>: The method achieves sub-micrometer spatial resolution and can detect refractive index changes below 10⁻³, essential for characterizing photoinscribed optical structures.</p></li></ol><p>Applications include optical metrology, waveguide characterization for integrated photonics, quality control in direct laser writing, and quantitative phase imaging of phase objects.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../03_RGB_beam_shaping/">« Multi-Wavelength Beam Shaping</a><a class="docs-footer-nextpage" href="../../api/">API Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Thursday 23 October 2025 18:40">Thursday 23 October 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
